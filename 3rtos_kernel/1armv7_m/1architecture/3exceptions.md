---
sort: 3
---
# 中断与中断处理


## 中断和中断向量表

#0~15 编号中断由 M3 内核定义，剩下的 16~255 由芯片厂家定义。

复位中断、不可屏蔽中断、硬 fault 终端的优先级固定。

中断向量表里存放了中断处理程序的入口地址。默认情况下，CM3 认为向量表位于 0x0 地址处。响应中断时，CM3 会根据中断号从表中找出对应的中断处理程序的入口地址。

对于 STM32 芯片来说，向量表如图

<figure>
  <img src="./images/3-1.png" width=500>
</figure>

代码中向量表的定义在启动文件中。

CM3 的向量表中的前两个值是 MSP 的初始值和复位向量的地址。CM3 复位时，首先会读这两个值，初始化 MSP 和 PC 寄存器。需要注意的是加载到 PC 的值要为 1，代表这是在 Thumb 状态下执行的。如果值为0 会被认为企图用 ARM 模式执行，这会使处理器发生异常。

初始化举例

<figure>
  <img src="./images/3-2.png" width=300>
</figure>

复位过程
- 1.设置栈空间
- 2.执行复位函数
- 3.跳转 `main`

map 文件中的地址和 main 实际开始地址不同，这也是表明了处理器执行在 thumb 状态。

## 向量表重定位

默认下，向量表从 0x0 开始，但是这也是可编程的。可以通过修改 NVIC 中的 重定位寄存器实现。复位后该寄存器的值为0，所以在地址 0 处需要有向量表。

向量表只能放在内部 flash 和 ram 区。并且向量表的起始地址是有限制的，偏移值必须必须为 2 的整次幂的值且大于中断向量个数。

向量表重定位的典型使用场景是 IAP 的应用。

<figure>
  <img src="./images/3-3.png" width=300>
</figure>

```note
IAP(In-Application Programming)

将存储空间分为两个空间，分为存储 IAP 程序和用户程序 ，通过一段代码对另外一段代码编程，而不需要专门的编程接口。这种应用场合需要两个程序
- IAP程序：不涉及产品功能，只通过某种方式接收上位机的数据，来更新第二段程序
- 用户代码：实现功能的代码

IAP 程序放在 flash 的起始位置，上电就执行，用户程序放在后面。用户程序再开始前，要把向量表放在自己的向量表位置。

```

## 中断响应过程


## 咬尾中断机制

## 晚到中断机制








