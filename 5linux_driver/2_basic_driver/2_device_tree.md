---
sort: 2
---
# 设备树

新版本的 Linux 中，ARM 相关的驱动全部采用了设备树。

uboot 启动时，加载了 zImage 和 dtb 到 DDR 里。用 `bootz 80800000 - 83000000` 启动。其中 `83000000` 存放的就是设备树。

设备树是嵌入式 linux 驱动工程师掌握的必备技能。

描述设备树的文件叫做 DTS(Device Tree Source)，这个 DTS 文件采用树形结构描述板级设备。设备数的存在也是为了把硬件相关的东西剥离出内核本身。

在现在的 linux 源码中，`arch/arm/mach-xxxx` 或者 `arch/arm/plat-xxxx` 下的 .c 文件都是用来描述板级的却区别的。用 C 语言来描述整个板上的设备信息。

单片机的驱动，直接写死，绝对有代码，可以用在所有芯片上。

然而，一款 CPU 可以设计出来的开发板太多了，如果每个开发板都用 .c 写死，带来的问题是，如果硬件上的改变，必须要编译整个内核。当然这不是最主要的问题，最关键的，linux 本身提供的功能上的东西，对于这种板级的描述信息，硬编码进内核，是不合适的。这也是 dts 引入 arm 的原因。

设备树源文件为 `*.dts`，编译出来的设备树二进制文件为 `*.dtb`，编译工具为 `dtc` 工具。

dtc 工具在 scripts 中，由 gcc 编译器编译出 dtc 工具。

编译设备树的命令为

`make dtbs`

或者编译指定的设备树

`make imx6ull_mini.dtb`

`arch/arm/boot/dts` 里的 makefile 根据架构型号，确定编译对应架构的开发板的设备树。因此，新增开发板对应的设备树，要记得在此文件中新增。


## 基本语法

设备树的头文件为 `.dtsi`，设备树也可以引用 `.h` 头文件，也可以引用 `.dts` 文件。在行为上，只是相当于把整个文件的内容复制过去，本质上都是文本文件，后缀只是给人看的。

这个设计也很好理解，设备树不仅仅描述了芯片外面挂的设备，也描述了 CPU 里的信息，因此，这部分是公共的，这些只写一次就好了。`imx6ull.dtsi` 就描述了 imx6ull 芯片的所有信息。

设备树语法很简单，几乎没啥学习成本，对着 imx6ull 看看就能明白的个大概。




